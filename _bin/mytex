#!/usr/bin/python2

def find_master(filename):
    """find the master .tex file"""
    with open(filename) as f:
        line = f.readline().rstrip(' \t\r\n')

    header = r'%MASTER='
    if line.startswith(header):
        return line[len(header):]
    else:
        return filename

from argh import arg
@arg('filename', type=str, help='.tex filename')
@arg('--temp', type=str, help='path for temporary file', default='.tmpTeX')
@arg('--latex', action='store_true', help='use latex rather than pdflatex', default=False)
@arg('-x', '--xelatex', action='store_true', help='use xelatex rather than pdflatex', default=False)
def run(filename, temp, latex, xelatex):
    """compile LaTeX without littering"""
    filename = find_master(filename)

    from utils import execute, mkdir
    mkdir(temp)
    execute('cp *.bst %s/' % temp)
    execute('cp *.bib %s/' % temp)

    mode = '-m pdftex'
    if latex:
        mode = ''
    if xelatex:
        mode = '-m xelatex'

    command = r'rubber --into .tmpTeX -fsq %s "%s"' % (mode, filename)
    execute(command, choke=True)

    from os.path import join, basename, splitext
    name = basename(splitext(filename)[0])
    if latex:
        execute('dvipdf %s %s' % (join(temp, name + '.dvi'), name + '.pdf'), choke=True)
    else:
        execute('cp "%s" .' % join(temp, name + '.pdf'), choke=True)

if __name__ == '__main__':
    from argh.helpers import ArghParser
    parser = ArghParser()
    parser.set_default_command(run)
    parser.dispatch()
